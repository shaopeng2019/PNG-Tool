(function(){var e=window.CompressItem=function(e){this.file=e.file||null,this.params=e.params,this.complateBack=e.complateBack||function(){},this.$container=$(".main .queue"),this.state=0,this.initDomRender()};e.prototype.initDomRender=function(){var e=this,t=function(e){for(var t=["image/gif","image/png","image/webp","image/jpeg","image/tiff"],a=0;a<t.length;a++)if(e===t[a])return!0;return!1},a='<div class="progress-value"><h2 class="result-tips"></h2></div>';e.file.size>20971520?(e.state=-1,a='<div class="progress-value error" style="width:100%;"><h2 class="result-tips">文件过大，不能超过20MB</h2></div>'):t(e.file.type)||(e.state=-1,a='<div class="progress-value error" style="width:100%;"><h2 class="result-tips">无法处理该格式的文件</h2></div>');var r='<div class="queue-item"><h2 class="name" >'+e.file.name+'</h2><div class="middle"><h2 class="original-size">'+e.getSizeText(e.file.size)+'</h2><div class="progress-box">'+a+'</div><h2 class="after-size"></h2></div><div class="right-group"><a class="download-link" href="javascript:void(0)">点击下载</a><h2 class="percentage"></h2></div></div >';e.$el=$(r),e.$progressValue=e.$el.find(".progress-value"),e.$progressTips=e.$progressValue.children(".result-tips"),e.$afterSize=e.$el.find(".after-size"),e.$rightGroup=e.$el.find(".right-group"),e.$percentage=e.$rightGroup.children(".percentage"),e.$download=e.$rightGroup.children(".download-link"),e.$container.append(e.$el)},e.prototype.start=function(){var e=this;e.state=1,e.file.size<2097152?e.fileRender(function(t){e.uploadService(function(t){e.complateBack()})}):(e.sliceSize=1048576,e.totalSliceCount=Math.ceil(e.file.size/e.sliceSize),e.currentSliceCount=0,e.fileSign=APP.utils.uuidCreate(),e.sliceUploadService(function(t){e.complateBack()}))},e.prototype.fileRender=function(e){var t=this,a=new FileReader;a.onload=function(t){e(this.result)},a.onprogress=function(e){var a=e.total,r=e.loaded,i=Math.floor(r/a*100);i>=50&&i<100?t.updateProgress(i,"Reading..."):i>=100&&t.updateProgress(i,"Processing...")},a.onerror=function(e){t.state=-1,t.updateProgress(100,"读取错误，请刷新重试")},a.onabort=function(e){t.state=-1,t.updateProgress(100,"读取已中断")},a.readAsDataURL(t.file)},e.prototype.uploadService=function(e){var t=this,a=new FormData;a.append("file",t.file);for(var r=Object.keys(t.params),i=0;i<r.length;i++){var s=r[i];a.append(s,t.params[s])}$.ajax({method:"POST",url:"/processing",data:a,processData:!1,contentType:!1,success:function(a){if(-1===a.error)return t.state=-1,t.updateProgress(100,a.message),e(),!1;var r=a.data.url,i=a.data.size;t.$afterSize.html(t.getSizeText(i)),t.$rightGroup.addClass("show");var s=Math.floor((t.file.size-i)/t.file.size*1e3)/10;s>=0?t.$percentage.html("- "+s+"%"):(s=Math.abs(s),t.$percentage.addClass("red"),t.$percentage.html("+ "+s+"%")),t.$download.attr("href",r),t.$download.attr("download",t.file.name),t.state=2,t.updateProgress(100,"Finished");var o=$(".download-all-btn .total"),n=Number(o.html());o.html(n+1),e()},error:function(e){t.state=-1,t.updateProgress(100,"网络不稳定，请重试")}})},e.prototype.sliceUploadService=function(e){var t=this,a=t.currentSliceCount*t.sliceSize,r=a+t.sliceSize,i=t.file.slice(a,r),s=new FormData;s.append("currentSliceCount",t.currentSliceCount),s.append("totalSliceCount",t.totalSliceCount),s.append("fileName",t.file.name),s.append("fileSign",t.fileSign),s.append("slice",i);for(var o=Object.keys(t.params),n=0;n<o.length;n++){var l=o[n];"id"===l?s.append(l,t.params[l]):t.currentSliceCount+1>=t.totalSliceCount&&s.append(l,t.params[l])}$.ajax({method:"POST",url:"/sliceprocessing",data:s,processData:!1,contentType:!1,success:function(a){if(-1===a.error)return t.state=-1,t.updateProgress(100,a.message),e(),!1;if(a.data.url){var r=a.data.url,i=a.data.size;t.$afterSize.html(t.getSizeText(i)),t.$rightGroup.addClass("show");var s=Math.floor((t.file.size-i)/t.file.size*1e3)/10;s>=0?t.$percentage.html("- "+s+"%"):(s=Math.abs(s),t.$percentage.addClass("red"),t.$percentage.html("+ "+s+"%")),t.$download.attr("href",r),t.$download.attr("download",t.file.name);var o=$(".download-all-btn .total"),n=Number(o.html());return o.html(n+1),t.state=2,t.updateProgress(100,"Finished"),e(),!1}var l=a.data.currentSliceCount+1;n=a.data.totalSliceCount;if(l>=n)t.updateProgress(100,"Processing...");else{s=Math.floor(l/n*100);t.updateProgress(s,s>16?s+"%":"")}t.currentSliceCount=a.data.currentSliceCount,t.sliceUploadService(e)},error:function(e){t.state=-1,t.updateProgress(100,"网络不稳定，请重试")}})},e.prototype.updateProgress=function(e,t){var a=this;a.$progressValue[0].style.cssText="width:"+e+"%",a.$progressTips.html(t),-1===a.state?a.$progressValue.addClass("error"):2===a.state&&a.$progressValue.addClass("success")},e.prototype.getSizeText=function(e){return e/1024<1?Math.floor(100*e)/100+" B":(e/=1024,e/1024<1?Math.floor(100*e)/100+" KB":(e/=1024,e/1024<1?Math.floor(100*e)/100+" MB":(e/=1024,Math.floor(100*e)/100+" TB")))};var t=window.Queue=function(e){this.concurrencyNumber=e.concurrencyNumber||3,this.endCallback=e.endCallback||function(){},this.historyFiles=[],this.candidateQueue=[],this.currentNumber=0};t.prototype.add=function(e,t){var a=this;if(e.length<=0)return!1;for(var r=0;r<e.length;r++)a.candidateQueue.push(new CompressItem({file:e[r],params:t,complateBack:function(){a.currentNumber--,a.checkQueue()}})),a.historyFiles.push(e[r]);a.checkQueue()},t.prototype.isExist=function(e){for(var t=this,a=0;a<t.historyFiles.length;a++){var r=t.historyFiles[a];if(r.name===e.name)return!0}return!1},t.prototype.checkQueue=function(){var e=this;if(e.currentNumber>=e.concurrencyNumber)return!1;for(var t=!0,a=!1,r=0;r<e.candidateQueue.length;r++){var i=e.candidateQueue[r];if(2===i.state&&(a=!0),0===i.state&&(i.start(),e.currentNumber++,t=!1,e.currentNumber>=e.concurrencyNumber))break}t&&e.currentNumber<=0&&(e.candidateQueue=[],a&&e.endCallback.call(e))}})();var handleEvns={pageLayoutFunc:function(){}},PageManage={toolCompress:function(){var e=new Queue({concurrencyNumber:5,endCallback:function(){$(".download-all-box").addClass("show")}}),t="pngtool"+APP.utils.uuidCreate();$(".download-all-btn").click(function(){window.location.href="/downloadzip/"+t}),$("#file").on("change",function(a){for(var r=$(this)[0].files,i=[],s=0;s<r.length;s++){var o=r[s];e.isExist(o)||i.push(o)}var n={id:t},l=$("#width").val().trim(),c=$("#height").val().trim(),u=$("#quality").val().trim();""===l||Object.is(Number(l),NaN)||(l=Math.floor(Number(l)),l=l<1?1:l,l=l>1e4?1e4:l,n.width=l),""===c||Object.is(Number(c),NaN)||(c=Math.floor(Number(c)),c=c<1?1:c,c=c>1e4?1e4:c,n.height=c),""===u||Object.is(Number(u),NaN)||(u=Math.floor(Number(u)),u=u<1?1:u,u=u>100?100:u,n.quality=u);var d=$(".user-options .select.ext .current").html().trim();n.ext=d;var p=$(".check-box.greyscale").hasClass("active");p&&(n.greyscale=p);var h=$("#watermark-file");if(h[0].files.length>0){n.watermask=h[0].files[0];var v=$(".watermask-position .current .item.active").index();n.watermaskPosition=Number(v)+1}e.add(i,n),a.target.value=""}),$("#width,#height").keyup(function(){var e=$(this),t=e.val().trim();return""===t?(e.val(""),!1):(t=Number(t),Object.is(t,NaN)?(e.val(""),!1):void(t>1e4?e.val(1e4):t<1&&e.val(1)))}),$("#quality").keyup(function(){var e=$(this),t=e.val().trim();return""===t?(e.val(""),!1):(t=Number(t),Object.is(t,NaN)?(e.val(""),!1):void(t>100?e.val(100):t<1&&e.val(1)))}),$(".user-options .option-group .select").click(function(e){e.stopPropagation()}),$(".user-options .option-group .select .current").click(function(e){e.stopPropagation();var t=$(this).parent();t.hasClass("active")?t.removeClass("active"):t.addClass("active"),$(".watermask-position").removeClass("active")}),$(".user-options .option-group .select .option-item").click(function(e){e.stopPropagation();var t=$(this).html();$(this).parent().siblings(".current").html(t),$(this).addClass("active").siblings().removeClass("active");var a=$(this).parents(".select");a.removeClass("active")}),$(".check-box.greyscale").click(function(){var e=$(this);e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),$(".uplad-watermark .clean-btn").click(function(){var e=$(this);e.parent().removeClass("active"),$("#watermark-file").val("")}),$("#watermark-file").change(function(){$(this);var e=$("#watermark-file")[0].files[0].size;if(e>1048576)return alert("水印大小不能超过1MB"),$("#watermark-file").val(""),!1;$(".uplad-watermark").addClass("active")}),$(".watermask-position .current").click(function(e){e.stopPropagation();var t=$(this).parent();t.hasClass("active")?t.removeClass("active"):t.addClass("active"),$(".user-options .option-group .select").removeClass("active")}),$(".watermask-position .options .item").click(function(){var e=$(this);e.addClass("active").siblings().removeClass("active");var t=e.index();$(".watermask-position .current .item").eq(t).addClass("active").siblings().removeClass("active")}),$(document).click(function(){$(".user-options .option-group .select").removeClass("active"),$(".watermask-position").removeClass("active")}),$(".instructions-btn").click(function(){var e=$(".instructions").offset().top;$("html,body").stop().animate({scrollTop:e},800)})}},app=new APP({pageManage:PageManage,handleEvns:handleEvns,before:function(){this.handleEvns.pageLayoutFunc()},after:function(){}});